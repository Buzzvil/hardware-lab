import logging

import subprocess
from django.http import JsonResponse
from django.utils import six

from ac import settings
from api.pynamodb_models import ACConfig
from ngrok.tasks import update_public_url


logger = logging.getLogger(__name__)

def hello(request):
    update_public_url.delay()
    res_dict = {'foo': 'testfwefwef'}
    return JsonResponse(res_dict)


def ac_command(btn_name):
    lg = subprocess.call(["irsend", "SEND_ONCE", "lg-ac", btn_name])
    samsung = subprocess.call(["irsend", "SEND_ONCE", "samsung-ac", btn_name])
    if lg != 0 or samsung != 0:
        return JsonResponse({'lg': lg, 'samsung': samsung}, status=500)
    return JsonResponse({})


def ac_on(request):
    state_button_map = {
        'verylow': 'BTN_3',
        'low': 'BTN_6',
        'medium': 'BTN_9',
        'high': 'BTN_11',
    }

    config = six.next(ACConfig.query(hash_key=settings.AC_LOCATION))
    btn_name = state_button_map[config.state]
    logger.info('ac_on state {} btn_name {}'.format(config.state, btn_name))
    return ac_command(btn_name)


def ac_off(request):
    return ac_command("BTN_0")

def ac_temp_very_low(request):
    return ac_command("BTN_3")

def ac_temp_low(request):
    return ac_command("BTN_6")

def ac_temp_medium(request):
    return ac_command("BTN_9")

def ac_temp_high(request):
    return ac_command("BTN_11")


def light_on(request):
    res = subprocess.call(["irsend", "SEND_ONCE", "light", "KEY_ON"])
    if res != 0:
        return JsonResponse({'res': res}, status=500)
    return JsonResponse({})


def light_color(request, color):
    if not color in ('R', 'G', 'B'):
        return JsonResponse({'error': 'Invalid color'})
    keyname = "KEY_" + color
    res = subprocess.call(["irsend", "SEND_ONCE", "light", keyname])
    if res != 0:
        return JsonResponse({'res': res}, status=500)
    return JsonResponse({})
